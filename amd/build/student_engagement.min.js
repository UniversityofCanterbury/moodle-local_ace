define("local_ace/student_engagement",["exports","core/ajax","core/str","core/modal_factory","core/templates","core/modal_events","core/chart_builder","core/chart_output_chartjs","core/notification","local_ace/chart_filters"],(function(_exports,_ajax,_str,_modal_factory,_templates,_modal_events,_chart_builder,_chart_output_chartjs,_notification,_chart_filters){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Uses the local_ace webservices to create engagement charts
   *
   * @module      local_ace/student_engagement
   * @copyright   2021 University of Canterbury
   * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_modal_factory=_interopRequireDefault(_modal_factory),_templates=_interopRequireDefault(_templates),_modal_events=_interopRequireDefault(_modal_events),_chart_builder=_interopRequireDefault(_chart_builder),_chart_output_chartjs=_interopRequireDefault(_chart_output_chartjs),_notification=_interopRequireDefault(_notification);let USER_ID={},COMPARISON_OPTION="average-course-engagement",START_TIME=null,END_TIME=null,SHOW_ALL_COURSES=!1,COLOURS=[];_exports.init=parameters=>{USER_ID=parameters.userid,COLOURS=parameters.colours;const filtersComplete=new Promise((resolve=>{(0,_chart_filters.init)(updateGraph),resolve(1)}));let params=new URLSearchParams(new URL(window.location.href).search);params.has("course")?0===parseInt(params.get("course"))&&(document.querySelector("#show-courses-buttons").style.display=null):document.querySelector("#show-courses-buttons").style.display=null,filtersComplete.then((()=>{document.querySelector("#chart-comparison").addEventListener("click",createChartComparisonModal),getComparisonMethodPreference().then((response=>{response.error&&displayError(response.error),null!==response.preferences[0].value&&(COMPARISON_OPTION=response.preferences[0].value),updateGraph()})).catch(_notification.default.exception)})),document.querySelector("#show-all-courses").addEventListener("click",showAllCourses),document.querySelector("#show-your-course").addEventListener("click",showYourCourse)};const showAllCourses=function(){document.querySelector("#show-all-courses").style.display="none",document.querySelector("#show-your-course").style.display=null,SHOW_ALL_COURSES=!0,document.querySelector("#student-engagement-legend").style.display="none",updateGraph()},showYourCourse=function(){document.querySelector("#show-your-course").style.display="none",document.querySelector("#show-all-courses").style.display=null,document.querySelector("#student-engagement-legend").style.display=null,SHOW_ALL_COURSES=!1,updateGraph()},createChartComparisonModal=function(){_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL}).then((function(modal){modal.getRoot()[0].classList.add("local_ace-slim-modal"),modal.setTitle("Change course comparison data");let templatePromise=_templates.default.render("local_ace/chart_comparison_body",{});return modal.setBody(templatePromise),modal.setSaveButtonText("Filter"),modal.getRoot().on(_modal_events.default.bodyRendered,(function(){if(document.querySelector("#comparison-"+COMPARISON_OPTION).checked=!0,SHOW_ALL_COURSES){document.querySelectorAll('input[name="comparison-options"]').forEach((ele=>{ele.disabled=!0}))}})),modal.getRoot().on(_modal_events.default.save,(function(){let checkedElement=document.querySelector('input[name="comparison-options"]:checked');COMPARISON_OPTION=null!==checkedElement?checkedElement.value:"none",updateGraph(),updateComparisonMethodPreference()})),modal.getRoot().on(_modal_events.default.hidden,(()=>{modal.destroy()})),modal.show(),modal})).fail(_notification.default.exception)},updateGraph=function(){let startDatetime=arguments.length>0&&void 0!==arguments[0]?arguments[0]:START_TIME,endDateTime=arguments.length>1&&void 0!==arguments[1]?arguments[1]:END_TIME;START_TIME!==startDatetime&&(START_TIME=startDatetime),END_TIME!==endDateTime&&(END_TIME=endDateTime);let url=new URL(window.location.href),params=new URLSearchParams(url.search),courseid=0;params.has("course")&&(courseid=parseInt(params.get("course")));let engagementDataPromise=getUserEngagementData(courseid,USER_ID,START_TIME,END_TIME).then((function(response){if(null!==response.error)return displayError(response.error),null;if(0===response.data.length)return(0,_str.get_string)("noanalytics","local_ace").then((langString=>{displayError(langString)})).catch(),null;let graphData=getGraphDataPlaceholder();graphData.legend_options.display=SHOW_ALL_COURSES;let i=0;response.data.forEach((data=>{let series=getSeriesPlaceholder();series.label=data.label,series.values=data.values,SHOW_ALL_COURSES||void 0===data.colour?(series.colors=[COLOURS[i%COLOURS.length]],i++):series.colors=[data.colour],series.fill=data.fill?1:null,graphData.series.push(series)})),graphData.labels=response.xlabels,graphData.axes.y[0].max=100,graphData.axes.y[0].stepSize=25;let yLabels={};return response.ylabels.forEach((element=>{yLabels[element.value]=element.label})),graphData.axes.y[0].labels=yLabels,graphData})).catch((function(){displayError("API returned an error")}));engagementDataPromise.then((data=>{if(null===data)return;let chartImage=document.querySelector("#chart-area-engagement").querySelector(".chart-image");chartImage.innerHTML="",_chart_builder.default.make(data).then((chart=>{let chartjs=new _chart_output_chartjs.default(chartImage,chart)._chartjs;chartjs.options.scales.xAxes[0].ticks.minor.autoSkip=!1,chartjs.update()})).catch()})).catch()},displayError=langString=>{document.querySelector("#chart-area-engagement").querySelector(".chart-image").innerHTML=langString},getUserEngagementData=function(courseid,userid,start,end){let comparison=arguments.length>4&&void 0!==arguments[4]?arguments[4]:COMPARISON_OPTION;return _ajax.default.call([{methodname:"local_ace_get_user_analytics_graph",args:{courseid:courseid,userid:userid,start:start,end:end,comparison:comparison,showallcourses:SHOW_ALL_COURSES}}])[0]},updateComparisonMethodPreference=function(){let request={methodname:"core_user_update_user_preferences",args:{preferences:[{type:"local_ace_comparison_method",value:COMPARISON_OPTION}]}};_ajax.default.call([request])[0].fail(_notification.default.exception)},getComparisonMethodPreference=function(){return _ajax.default.call([{methodname:"core_user_get_user_preferences",args:{name:"local_ace_comparison_method"}}])[0]},getGraphDataPlaceholder=()=>({type:"line",series:[],labels:null,title:null,axes:{x:[],y:[{label:null,labels:{},max:null,min:0,position:null,stepSize:null}]},legend_options:{display:!1},config_colorset:null,smooth:!0}),getSeriesPlaceholder=()=>({label:"",labels:null,type:null,values:[],colors:[],fill:null,axes:{x:null,y:null},urls:[],smooth:null})}));

//# sourceMappingURL=student_engagement.min.js.map