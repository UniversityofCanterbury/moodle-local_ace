{"version":3,"sources":["../src/activity_engagement.js"],"names":["CMID","CUMULATIVE","START_TIME","END_TIME","COLOUR_ACTIVITY_ENGAGEMENT","init","parameters","colouractivityengagement","cmid","updateGraph","document","querySelector","addEventListener","showCumulativeGraph","showDaily","style","display","displayError","langString","chartArea","chartImage","innerHTML","startDatetime","endDateTime","engagementData","getActivityEngagementData","then","response","error","series","length","data","getGraphDataPlaceholder","values","labels","xlabels","axes","y","max","stepSize","stepsize","yLabels","ylabels","forEach","element","value","label","catch","ChartBuilder","make","chart","ChartJSOutput","start","end","Ajax","call","methodname","args"],"mappings":"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","sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Shows the activity engagement graph\n *\n * @module      local_ace/activity_engagement\n * @copyright   2021 University of Canterbury\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport ChartBuilder from 'core/chart_builder';\nimport ChartJSOutput from 'core/chart_output_chartjs';\nimport {init as filtersInit} from 'local_ace/chart_filters';\n\n// The course module ID that we are showing engagement data for.\nlet CMID = 0;\n// If true we show the cumulative graph.\nlet CUMULATIVE = false;\n// Stores the current time method, allowing us to update the graph without supplying values.\nlet START_TIME = null;\nlet END_TIME = null;\n// Colour of the activity engagement line.\nlet COLOUR_ACTIVITY_ENGAGEMENT = null;\n\n/**\n * Initialise the course engagement graph\n *\n * @param {Object} parameters Data passed from the server.\n */\nexport const init = (parameters) => {\n    if (CMID !== 0) {\n        return;\n    }\n    COLOUR_ACTIVITY_ENGAGEMENT = parameters.colouractivityengagement;\n    CMID = parameters.cmid;\n    filtersInit(updateGraph);\n\n    document.querySelector('#show-cumulative').addEventListener('click', showCumulativeGraph);\n    document.querySelector('#show-daily-access').addEventListener('click', showDaily);\n};\n\n/**\n * Show cumulative engagement data.\n */\nconst showCumulativeGraph = () => {\n    CUMULATIVE = true;\n    updateGraph();\n    document.querySelector('#show-cumulative').style.display = 'none';\n    document.querySelector('#show-daily-access').style.display = null;\n};\n\n/**\n * Show daily engagement data.\n */\nconst showDaily = () => {\n    CUMULATIVE = false;\n    updateGraph();\n    document.querySelector('#show-cumulative').style.display = null;\n    document.querySelector('#show-daily-access').style.display = 'none';\n};\n\n/**\n * Display an error on the page, which replaces the engagement graphs on the page.\n *\n * @param {string} langString Text displayed on the page\n */\nconst displayError = (langString) => {\n    let chartArea = document.querySelector('#chart-area-engagement');\n    let chartImage = chartArea.querySelector('.chart-image');\n    chartImage.innerHTML = langString;\n};\n\n/**\n * Update the graph display based on values fetched from a webservice.\n *\n * @param {Number|null} startDatetime\n * @param {Number|null} endDateTime\n */\nconst updateGraph = (startDatetime = START_TIME, endDateTime = END_TIME) => {\n    if (START_TIME !== startDatetime) {\n        START_TIME = startDatetime;\n    }\n    if (END_TIME !== endDateTime) {\n        END_TIME = endDateTime;\n    }\n\n    let engagementData = getActivityEngagementData(startDatetime, endDateTime).then((response) => {\n        if (response.error !== null || response.series.length === 0) {\n            displayError(response.error);\n            return null;\n        }\n        let data = getGraphDataPlaceholder();\n        data.series[0].values = response.series;\n        data.labels = response.xlabels;\n        data.axes.y[0].max = response.max;\n        data.axes.y[0].stepSize = response.stepsize;\n        let yLabels = {};\n        response.ylabels.forEach((element) => {\n            yLabels[element.value] = element.label;\n        });\n        data.axes.y[0].labels = yLabels;\n\n        return data;\n    }).catch(() => {\n        displayError(\"API Error\");\n    });\n\n    engagementData.then((data) => {\n        if (data === null) {\n            return;\n        }\n        let chartArea = document.querySelector('#chart-area-engagement');\n        let chartImage = chartArea.querySelector('.chart-image');\n        chartImage.innerHTML = \"\";\n        ChartBuilder.make(data).then((chart) => {\n            new ChartJSOutput(chartImage, chart);\n            return;\n        }).catch();\n        return;\n    }).catch();\n};\n\nconst getGraphDataPlaceholder = () => {\n    return {\n        \"type\": \"line\",\n        \"series\": [\n            {\n                \"label\": \"Activity Engagement\",\n                \"labels\": null,\n                \"type\": null,\n                \"values\": null,\n                \"colors\": [COLOUR_ACTIVITY_ENGAGEMENT],\n                \"fill\": null,\n                \"axes\": {\n                    \"x\": null,\n                    \"y\": null\n                },\n                \"urls\": [],\n                \"smooth\": null\n            },\n        ],\n        \"labels\": null,\n        \"title\": null,\n        \"axes\": {\n            \"x\": [],\n            \"y\": [\n                {\n                    \"label\": null,\n                    \"labels\": {},\n                    \"max\": null,\n                    \"min\": 0,\n                    \"position\": null,\n                    \"stepSize\": null\n                }\n            ]\n        },\n        \"legend_options\": {\n            \"display\": false\n        },\n        \"config_colorset\": null,\n        \"smooth\": true\n    };\n};\n\n/**\n * Get activity engagement data\n *\n * @param {Number|null} start Start time of analytics period in seconds\n * @param {Number|null} end End of analytics period in seconds\n * @returns {Promise}\n */\nconst getActivityEngagementData = (start, end) => {\n    return Ajax.call([{\n        methodname: 'local_ace_get_activity_analytics_graph',\n        args: {\n            'cmid': CMID,\n            'start': start,\n            'end': end,\n            'cumulative': CUMULATIVE\n        },\n    }])[0];\n};\n"],"file":"activity_engagement.min.js"}