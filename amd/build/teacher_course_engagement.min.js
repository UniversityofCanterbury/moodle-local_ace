define("local_ace/teacher_course_engagement",["exports","core/ajax","core/chart_builder","core/chart_output_chartjs","core/notification","core/modal_factory","core/modal_events","core/templates","local_ace/chart_filters"],(function(_exports,_ajax,_chart_builder,_chart_output_chartjs,_notification,_modal_factory,_modal_events,_templates,_chart_filters){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Shows the teacher course engagement graph
   *
   * @module      local_ace/teacher_course_engagement
   * @copyright   2021 University of Canterbury
   * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_chart_builder=_interopRequireDefault(_chart_builder),_chart_output_chartjs=_interopRequireDefault(_chart_output_chartjs),_notification=_interopRequireDefault(_notification),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates);var HIDDEN_COURSES=[],COURSES=[],COLOURS=[];_exports.init=function(parameters){COLOURS=parameters.colours,(0,_chart_filters.init)(updateGraph),document.querySelector("#course-filter").addEventListener("click",courseFilter)};var courseFilter=function(){_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL}).then((function(modal){modal.getRoot()[0].classList.add("local_ace-slim-modal"),modal.setTitle("Course filter");var templatePromise=_templates.default.render("local_ace/course_filter_modal",{courses:COURSES});return modal.setBody(templatePromise),modal.setSaveButtonText("Filter"),modal.getRoot().on(_modal_events.default.bodyRendered,(function(){HIDDEN_COURSES.forEach((function(shortname){var input=document.querySelector("input[id=course-filter-"+shortname+"]");null!==input&&(input.checked=!1)}))})),modal.getRoot().on(_modal_events.default.save,(function(){document.querySelectorAll('input[name="course-filter-options"]:not(:checked)').forEach((function(ele){HIDDEN_COURSES.includes(ele.value)||HIDDEN_COURSES.push(ele.value)})),updateGraph()})),modal.getRoot().on(_modal_events.default.hidden,(function(){modal.destroy()})),modal.show(),modal})).fail(_notification.default.exception)},updateGraph=function(startDate,endDate){getTeacherCourseEngagementData(startDate,endDate).then((function(response){if(null!==response.error||0===response.series.length)return displayError(response.error),null;var data=getGraphDataPlaceholder();COURSES=[];var i=0;response.series.forEach((function(series){COURSES.push({shortname:series.label});var seriesData=getSeriesPlaceholder();seriesData.label=series.label,seriesData.values=series.values,seriesData.colors=[COLOURS[i%COLOURS.length]],i++,data.series.push(seriesData)})),data.labels=response.xlabels,data.axes.y[0].max=100,data.axes.y[0].stepSize=25;var yLabels={};return response.ylabels.forEach((function(element){yLabels[element.value]=element.label})),data.axes.y[0].labels=yLabels,response.series.length>8&&(document.querySelector("#course-filter-wrap").style.display=null),data})).catch((function(){displayError("API Error")})).then((function(data){if(null!==data){var chartImage=document.querySelector("#chart-area-engagement").querySelector(".chart-image");chartImage.innerHTML="",_chart_builder.default.make(data).then((function(chart){var chartoutput=new _chart_output_chartjs.default(chartImage,chart);getHiddenCourses().then((function(response){if(!response.error){var courseList=response.preferences[0].value;if(null!==courseList){HIDDEN_COURSES=courseList.split(",");var chartjs=chartoutput._chartjs;for(var dataset in chartjs.data.datasets){var datasetObject=chartjs.data.datasets[dataset];HIDDEN_COURSES.includes(datasetObject.label)&&(datasetObject.hidden=!0)}chartjs.update()}}})).fail(_notification.default.exception)})).catch()}})).catch()},getSeriesPlaceholder=function(){return{label:"",labels:null,type:null,values:[],colors:[],fill:null,axes:{x:null,y:null},urls:[],smooth:null}},getGraphDataPlaceholder=function(){return{type:"line",series:[],labels:[],title:"Course Engagement",axes:{x:[],y:[{label:null,labels:{},max:100,min:0,position:null,stepSize:null}]},legend_options:{display:!0,position:"right",onClick:legendClickHandler},config_colorset:null,smooth:!0}},legendClickHandler=function(e,legendItem){var index=legendItem.datasetIndex,ci=this.chart;null===ci.getDatasetMeta(index).hidden&&(ci.data.datasets[index].hidden?(HIDDEN_COURSES=HIDDEN_COURSES.filter((function(course){return course!==ci.data.datasets[index].label})),updateHiddenCourses(),ci.data.datasets[index].hidden=!1):(HIDDEN_COURSES.push(ci.data.datasets[index].label),updateHiddenCourses(),ci.data.datasets[index].hidden=!0)),ci.update()},updateHiddenCourses=function(){var request={methodname:"core_user_update_user_preferences",args:{preferences:[{type:"local_ace_teacher_hidden_courses",value:HIDDEN_COURSES.join(",")}]}};_ajax.default.call([request])[0].fail(_notification.default.exception)},getHiddenCourses=function(){return _ajax.default.call([{methodname:"core_user_get_user_preferences",args:{name:"local_ace_teacher_hidden_courses"}}])[0]},displayError=function(langString){document.querySelector("#chart-area-engagement").querySelector(".chart-image").innerHTML=langString},getTeacherCourseEngagementData=function(start,end){return _ajax.default.call([{methodname:"local_ace_get_teacher_course_analytics_graph",args:{start:start,end:end}}])[0]}}));

//# sourceMappingURL=teacher_course_engagement.min.js.map