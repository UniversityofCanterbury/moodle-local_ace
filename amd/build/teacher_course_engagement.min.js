define("local_ace/teacher_course_engagement",["exports","core/ajax","core/chart_builder","core/chart_output_chartjs","core/notification","core/modal_factory","core/modal_events","core/templates","local_ace/chart_filters"],(function(_exports,_ajax,_chart_builder,_chart_output_chartjs,_notification,_modal_factory,_modal_events,_templates,_chart_filters){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Shows the teacher course engagement graph
   *
   * @module      local_ace/teacher_course_engagement
   * @copyright   2021 University of Canterbury
   * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_chart_builder=_interopRequireDefault(_chart_builder),_chart_output_chartjs=_interopRequireDefault(_chart_output_chartjs),_notification=_interopRequireDefault(_notification),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates);let HIDDEN_COURSES=[],COURSES=[],COLOURS=[];_exports.init=parameters=>{COLOURS=parameters.colours,(0,_chart_filters.init)(updateGraph),document.querySelector("#course-filter").addEventListener("click",courseFilter)};const courseFilter=()=>{_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL}).then((function(modal){modal.getRoot()[0].classList.add("local_ace-slim-modal"),modal.setTitle("Course filter");let templatePromise=_templates.default.render("local_ace/course_filter_modal",{courses:COURSES});return modal.setBody(templatePromise),modal.setSaveButtonText("Filter"),modal.getRoot().on(_modal_events.default.bodyRendered,(function(){HIDDEN_COURSES.forEach((shortname=>{let input=document.querySelector("input[id=course-filter-"+shortname+"]");null!==input&&(input.checked=!1)}))})),modal.getRoot().on(_modal_events.default.save,(function(){document.querySelectorAll('input[name="course-filter-options"]:not(:checked)').forEach((ele=>{HIDDEN_COURSES.includes(ele.value)||HIDDEN_COURSES.push(ele.value)})),updateGraph()})),modal.getRoot().on(_modal_events.default.hidden,(()=>{modal.destroy()})),modal.show(),modal})).fail(_notification.default.exception)},updateGraph=(startDate,endDate)=>{getTeacherCourseEngagementData(startDate,endDate).then((response=>{if(null!==response.error||0===response.series.length)return displayError(response.error),null;let data=getGraphDataPlaceholder();COURSES=[];let i=0;response.series.forEach((series=>{COURSES.push({shortname:series.label});let seriesData=getSeriesPlaceholder();seriesData.label=series.label,seriesData.values=series.values,seriesData.colors=[COLOURS[i%COLOURS.length]],i++,data.series.push(seriesData)})),data.labels=response.xlabels,data.axes.y[0].max=100,data.axes.y[0].stepSize=25;let yLabels={};return response.ylabels.forEach((element=>{yLabels[element.value]=element.label})),data.axes.y[0].labels=yLabels,response.series.length>8&&(document.querySelector("#course-filter-wrap").style.display=null),data})).catch((()=>{displayError("API Error")})).then((data=>{if(null===data)return;let chartImage=document.querySelector("#chart-area-engagement").querySelector(".chart-image");chartImage.innerHTML="",_chart_builder.default.make(data).then((chart=>{let chartoutput=new _chart_output_chartjs.default(chartImage,chart);getHiddenCourses().then((response=>{if(response.error)return;let courseList=response.preferences[0].value;if(null===courseList)return;HIDDEN_COURSES=courseList.split(",");let chartjs=chartoutput._chartjs;for(let dataset in chartjs.data.datasets){let datasetObject=chartjs.data.datasets[dataset];HIDDEN_COURSES.includes(datasetObject.label)&&(datasetObject.hidden=!0)}chartjs.update()})).fail(_notification.default.exception)})).catch()})).catch()},getSeriesPlaceholder=()=>({label:"",labels:null,type:null,values:[],colors:[],fill:null,axes:{x:null,y:null},urls:[],smooth:null}),getGraphDataPlaceholder=()=>({type:"line",series:[],labels:[],title:"Course Engagement",axes:{x:[],y:[{label:null,labels:{},max:100,min:0,position:null,stepSize:null}]},legend_options:{display:!0,position:"right",onClick:legendClickHandler},config_colorset:null,smooth:!0}),legendClickHandler=function(e,legendItem){let index=legendItem.datasetIndex,ci=this.chart;null===ci.getDatasetMeta(index).hidden&&(ci.data.datasets[index].hidden?(HIDDEN_COURSES=HIDDEN_COURSES.filter((course=>course!==ci.data.datasets[index].label)),updateHiddenCourses(),ci.data.datasets[index].hidden=!1):(HIDDEN_COURSES.push(ci.data.datasets[index].label),updateHiddenCourses(),ci.data.datasets[index].hidden=!0)),ci.update()},updateHiddenCourses=function(){let request={methodname:"core_user_update_user_preferences",args:{preferences:[{type:"local_ace_teacher_hidden_courses",value:HIDDEN_COURSES.join(",")}]}};_ajax.default.call([request])[0].fail(_notification.default.exception)},getHiddenCourses=function(){return _ajax.default.call([{methodname:"core_user_get_user_preferences",args:{name:"local_ace_teacher_hidden_courses"}}])[0]},displayError=langString=>{document.querySelector("#chart-area-engagement").querySelector(".chart-image").innerHTML=langString},getTeacherCourseEngagementData=(start,end)=>_ajax.default.call([{methodname:"local_ace_get_teacher_course_analytics_graph",args:{start:start,end:end}}])[0]}));

//# sourceMappingURL=teacher_course_engagement.min.js.map