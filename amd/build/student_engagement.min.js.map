{"version":3,"file":"student_engagement.min.js","sources":["../src/student_engagement.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Uses the local_ace webservices to create engagement charts\n *\n * @module      local_ace/student_engagement\n * @copyright   2021 University of Canterbury\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport {get_string as getString} from 'core/str';\nimport ModalFactory from 'core/modal_factory';\nimport Templates from 'core/templates';\nimport ModalEvents from \"core/modal_events\";\nimport ChartBuilder from 'core/chart_builder';\nimport ChartJSOutput from 'core/chart_output_chartjs';\nimport Notification from 'core/notification';\nimport {init as filtersInit} from 'local_ace/chart_filters';\n\nlet USER_ID = {};\n// Stores the chosen comparison method.\nlet COMPARISON_OPTION = 'average-course-engagement';\n// Stores the current time method, allowing us to update the graph without supplying values.\nlet START_TIME = null;\nlet END_TIME = null;\n// Toggles the retrieval of a single course vs all courses enrolleid in.\nlet SHOW_ALL_COURSES = false;\n\nlet COLOURS = [];\n\n/**\n * Retrieves data from the local_ace webservice to populate an engagement graph\n *\n * @param {Object} parameters Data passed from the server.\n */\nexport const init = (parameters) => {\n    USER_ID = parameters.userid;\n    COLOURS = parameters.colours;\n    // Init filters in a promise which we'll wait to complete,\n    // to prevent updating graph twice at the same time.\n    const filtersComplete = new Promise((resolve) => {\n        filtersInit(updateGraph);\n        resolve(1);\n    });\n\n    // Hide the 'Show all courses' button on every tab except 'Overall' (course=0).\n    let params = new URLSearchParams(new URL(window.location.href).search);\n    if (params.has('course')) {\n        if (parseInt(params.get('course')) === 0) {\n            document.querySelector('#show-courses-buttons').style.display = null;\n        }\n    } else {\n        document.querySelector('#show-courses-buttons').style.display = null;\n    }\n\n    // Wait for filters to be initialised before updating graph.\n    filtersComplete.then(() => {\n        // Setup chart comparison control.\n        let chartComparisonButton = document.querySelector(\"#chart-comparison\");\n        chartComparisonButton.addEventListener(\"click\", createChartComparisonModal);\n        // Retrieve user preference and set our comparison option, then update the graph.\n        getComparisonMethodPreference().then(response => {\n            if (response.error) {\n                displayError(response.error);\n            }\n            if (response.preferences[0].value !== null) {\n                COMPARISON_OPTION = response.preferences[0].value;\n            }\n            updateGraph();\n        }).catch(Notification.exception);\n    });\n\n    document.querySelector(\"#show-all-courses\").addEventListener(\"click\", showAllCourses);\n    document.querySelector(\"#show-your-course\").addEventListener(\"click\", showYourCourse);\n};\n\nconst showAllCourses = function() {\n    document.querySelector(\"#show-all-courses\").style.display = 'none';\n    document.querySelector(\"#show-your-course\").style.display = null;\n    SHOW_ALL_COURSES = true;\n    document.querySelector(\"#student-engagement-legend\").style.display = 'none';\n    updateGraph();\n};\n\nconst showYourCourse = function() {\n    document.querySelector(\"#show-your-course\").style.display = 'none';\n    document.querySelector(\"#show-all-courses\").style.display = null;\n    document.querySelector(\"#student-engagement-legend\").style.display = null;\n    SHOW_ALL_COURSES = false;\n    updateGraph();\n};\n\n/**\n * Creates the chart comparison modal.\n */\nconst createChartComparisonModal = function() {\n    var modalPromise = ModalFactory.create({type: ModalFactory.types.SAVE_CANCEL});\n\n    modalPromise.then(function(modal) {\n        modal.getRoot()[0].classList.add('local_ace-slim-modal');\n        modal.setTitle(\"Change course comparison data\");\n        let templatePromise = Templates.render('local_ace/chart_comparison_body', {});\n        modal.setBody(templatePromise);\n        modal.setSaveButtonText(\"Filter\");\n\n        // Check the comparison option on load.\n        modal.getRoot().on(ModalEvents.bodyRendered, function() {\n            document.querySelector('#comparison-' + COMPARISON_OPTION).checked = true;\n            // If all courses are shown then we cannot show comparisons.\n            if (SHOW_ALL_COURSES) {\n                let elements = document.querySelectorAll('input[name=\"comparison-options\"]');\n                elements.forEach((ele) => {\n                    ele.disabled = true;\n                });\n            }\n        });\n\n        // Update COMPARISON_OPTION when the modal is saved.\n        modal.getRoot().on(ModalEvents.save, function() {\n            let checkedElement = document.querySelector('input[name=\"comparison-options\"]:checked');\n            if (checkedElement !== null) {\n                COMPARISON_OPTION = checkedElement.value;\n            } else {\n                COMPARISON_OPTION = 'none';\n            }\n            updateGraph();\n            updateComparisonMethodPreference();\n        });\n\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            // Destroy when hidden, removes modal HTML from document.\n            modal.destroy();\n        });\n\n        modal.show();\n\n        return modal;\n    }).fail(Notification.exception);\n};\n\n/**\n * Update the graph display based on values fetched from a webservice.\n *\n * @param {Number|null} startDatetime\n * @param {Number|null} endDateTime\n */\nconst updateGraph = (startDatetime = START_TIME, endDateTime = END_TIME) => {\n    if (START_TIME !== startDatetime) {\n        START_TIME = startDatetime;\n    }\n    if (END_TIME !== endDateTime) {\n        END_TIME = endDateTime;\n    }\n\n    let url = new URL(window.location.href);\n    let params = new URLSearchParams(url.search);\n    let courseid = 0;\n    if (params.has('course')) {\n        courseid = parseInt(params.get('course'));\n    }\n    let engagementDataPromise = getUserEngagementData(courseid, USER_ID, START_TIME, END_TIME)\n        .then(function(response) {\n            // Check for any errors before processing.\n            if (response.error !== null) {\n                displayError(response.error);\n                return null;\n            } else if (response.data.length === 0) {\n                getString('noanalytics', 'local_ace').then((langString) => {\n                    displayError(langString);\n                    return;\n                }).catch();\n                return null;\n            }\n\n            // Populate empty fields.\n            let graphData = getGraphDataPlaceholder();\n            graphData.legend_options.display = SHOW_ALL_COURSES;\n            // Create individual series data.\n            let i = 0;\n            response.data.forEach((data) => {\n                let series = getSeriesPlaceholder();\n                series.label = data.label;\n                series.values = data.values;\n                if (SHOW_ALL_COURSES || data.colour === undefined) {\n                    // Choose a colour from the array and wrap around when reaching the end.\n                    series.colors = [COLOURS[i % COLOURS.length]];\n                    i++;\n                } else {\n                    series.colors = [data.colour];\n                }\n                series.fill = data.fill ? 1 : null;\n                graphData.series.push(series);\n            });\n            graphData.labels = response.xlabels;\n            graphData.axes.y[0].max = 100;\n            graphData.axes.y[0].stepSize = 25;\n            let yLabels = {};\n            response.ylabels.forEach((element) => {\n                yLabels[element.value] = element.label;\n            });\n            graphData.axes.y[0].labels = yLabels;\n\n            return graphData;\n        }).catch(function() {\n            displayError(\"API returned an error\");\n        });\n\n    engagementDataPromise.then((data) => {\n        if (data === null) {\n            return;\n        }\n        let chartArea = document.querySelector('#chart-area-engagement');\n        let chartImage = chartArea.querySelector('.chart-image');\n        chartImage.innerHTML = \"\";\n        ChartBuilder.make(data).then((chart) => {\n            // Render graph\n            let chartoutput = new ChartJSOutput(chartImage, chart);\n            // Disable autoskip on x axis.\n            let chartjs = chartoutput._chartjs;\n            chartjs.options.scales.xAxes[0].ticks.minor.autoSkip = false;\n            chartjs.update();\n            return;\n        }).catch();\n        return;\n    }).catch();\n};\n\n/**\n * Display an error on the page, which replaces the engagement graphs on the page.\n *\n * @param {String} langString Text displayed on the page\n */\nconst displayError = (langString) => {\n    let chartArea = document.querySelector('#chart-area-engagement');\n    let chartImage = chartArea.querySelector('.chart-image');\n    chartImage.innerHTML = langString;\n};\n\n/**\n * Get analytics data for specific user and course, within a certain period and after a starting time.\n *\n * @param {Number|null} courseid Course ID\n * @param {Number} userid User ID\n * @param {Number} start Start time of analytics period in seconds\n * @param {Number} end End of analytics period in seconds\n * @param {String} comparison Comparison method\n * @returns {Promise}\n */\nconst getUserEngagementData = (courseid, userid, start, end, comparison = COMPARISON_OPTION) => {\n    return Ajax.call([{\n        methodname: 'local_ace_get_user_analytics_graph',\n        args: {\n            'courseid': courseid,\n            'userid': userid,\n            'start': start,\n            'end': end,\n            'comparison': comparison,\n            'showallcourses': SHOW_ALL_COURSES,\n        },\n    }])[0];\n};\n\n/**\n * Updates the comparison method user preference.\n */\nconst updateComparisonMethodPreference = function() {\n    let request = {\n        methodname: 'core_user_update_user_preferences',\n        args: {\n            preferences: [\n                {\n                    type: 'local_ace_comparison_method',\n                    value: COMPARISON_OPTION\n                }\n            ]\n        }\n    };\n\n    Ajax.call([request])[0].fail(Notification.exception);\n};\n\n/**\n * Return a promise for the comparison method user preference.\n *\n * @returns {Promise}\n */\nconst getComparisonMethodPreference = function() {\n    let request = {\n        methodname: 'core_user_get_user_preferences',\n        args: {\n            name: 'local_ace_comparison_method'\n        }\n    };\n    return Ajax.call([request])[0];\n};\n\n/**\n * Get a graph.js data object filled out with the values we need for a student engagement graph.\n *\n * @returns {Object}\n */\nconst getGraphDataPlaceholder = () => {\n    return {\n        \"type\": \"line\",\n        \"series\": [],\n        \"labels\": null,\n        \"title\": null,\n        \"axes\": {\n            \"x\": [],\n            \"y\": [\n                {\n                    \"label\": null,\n                    \"labels\": {},\n                    \"max\": null,\n                    \"min\": 0,\n                    \"position\": null,\n                    \"stepSize\": null\n                }\n            ]\n        },\n        \"legend_options\": {\n            \"display\": false\n        },\n        \"config_colorset\": null,\n        \"smooth\": true\n    };\n};\n\nconst getSeriesPlaceholder = () => {\n    return {\n        \"label\": \"\",\n        \"labels\": null,\n        \"type\": null,\n        \"values\": [],\n        \"colors\": [],\n        \"fill\": null,\n        \"axes\": {\n            \"x\": null,\n            \"y\": null\n        },\n        \"urls\": [],\n        \"smooth\": null\n    };\n};\n"],"names":["USER_ID","COMPARISON_OPTION","START_TIME","END_TIME","SHOW_ALL_COURSES","COLOURS","parameters","userid","colours","filtersComplete","Promise","resolve","updateGraph","params","URLSearchParams","URL","window","location","href","search","has","parseInt","get","document","querySelector","style","display","then","addEventListener","createChartComparisonModal","getComparisonMethodPreference","response","error","displayError","preferences","value","catch","Notification","exception","showAllCourses","showYourCourse","ModalFactory","create","type","types","SAVE_CANCEL","modal","getRoot","classList","add","setTitle","templatePromise","Templates","render","setBody","setSaveButtonText","on","ModalEvents","bodyRendered","checked","querySelectorAll","forEach","ele","disabled","save","checkedElement","updateComparisonMethodPreference","hidden","destroy","show","fail","startDatetime","endDateTime","url","courseid","engagementDataPromise","getUserEngagementData","data","length","langString","graphData","getGraphDataPlaceholder","legend_options","i","series","getSeriesPlaceholder","label","values","undefined","colour","colors","fill","push","labels","xlabels","axes","y","max","stepSize","yLabels","ylabels","element","chartImage","innerHTML","make","chart","chartjs","ChartJSOutput","_chartjs","options","scales","xAxes","ticks","minor","autoSkip","update","start","end","comparison","Ajax","call","methodname","args","request","name"],"mappings":"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"}