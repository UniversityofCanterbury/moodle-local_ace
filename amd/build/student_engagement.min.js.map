{"version":3,"sources":["../src/student_engagement.js"],"names":["COLOUR_USER_HISTORY","USER_ID","COMPARISON_OPTION","START_TIME","END_TIME","init","parameters","colouruserhistory","userid","updateGraph","chartComparisonButton","document","querySelector","addEventListener","modalPromise","ModalFactory","create","type","types","SAVE_CANCEL","then","modal","getRoot","classList","add","setTitle","templatePromise","Templates","render","setBody","setSaveButtonText","on","ModalEvents","bodyRendered","checked","save","checkedElement","value","hidden","destroy","show","fail","Notification","exception","startDatetime","endDateTime","url","URL","window","location","href","params","URLSearchParams","search","courseid","has","parseInt","get","engagementDataPromise","getUserEngagementData","response","error","displayError","series","length","langString","catch","graphData","getGraphDataPlaceholder","values","comparison","forEach","getSeriesPlaceholder","label","colors","colour","fill","push","labels","axes","y","max","stepSize","stepsize","yLabels","ylabels","element","data","chartArea","chartImage","innerHTML","ChartBuilder","make","chart","ChartJSOutput","start","end","Ajax","call","methodname","args"],"mappings":"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","sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Uses the local_ace webservices to create engagement charts\n *\n * @module      local_ace/student_engagement\n * @copyright   2021 University of Canterbury\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport {get_string as getString} from 'core/str';\nimport ModalFactory from 'core/modal_factory';\nimport Templates from 'core/templates';\nimport ModalEvents from \"core/modal_events\";\nimport ChartBuilder from 'core/chart_builder';\nimport ChartJSOutput from 'core/chart_output_chartjs';\nimport {init as filtersInit} from 'local_ace/chart_filters';\n\nlet COLOUR_USER_HISTORY;\nlet USER_ID = {};\n// Stores the chosen comparison method.\nlet COMPARISON_OPTION = 'average-course-engagement';\n// Stores the current time method, allowing us to update the graph without supplying values.\nlet START_TIME = null;\nlet END_TIME = null;\n\n/**\n * Retrieves data from the local_ace webservice to populate an engagement graph\n *\n * @param {Object} parameters Data passed from the server.\n */\nexport const init = (parameters) => {\n    COLOUR_USER_HISTORY = parameters.colouruserhistory;\n    USER_ID = parameters.userid;\n    filtersInit(updateGraph);\n    updateGraph();\n\n    // Setup chart comparison control.\n    let chartComparisonButton = document.querySelector(\"#chart-comparison\");\n    chartComparisonButton.addEventListener(\"click\", () => {\n        var modalPromise = ModalFactory.create({type: ModalFactory.types.SAVE_CANCEL});\n\n        modalPromise.then(function(modal) {\n            modal.getRoot()[0].classList.add('chart-comparison-modal');\n            modal.setTitle(\"Change course comparison data\");\n            let templatePromise = Templates.render('local_ace/chart_comparison_body', {});\n            modal.setBody(templatePromise);\n            modal.setSaveButtonText(\"Filter\");\n\n            // Check the comparison option on load.\n            modal.getRoot().on(ModalEvents.bodyRendered, function() {\n                document.querySelector('#comparison-' + COMPARISON_OPTION).checked = true;\n            });\n\n            // Update COMPARISON_OPTION when the modal is saved.\n            modal.getRoot().on(ModalEvents.save, function() {\n                let checkedElement = document.querySelector('input[name=\"comparison-options\"]:checked');\n                if (checkedElement !== null) {\n                    COMPARISON_OPTION = checkedElement.value;\n                } else {\n                    COMPARISON_OPTION = 'none';\n                }\n                updateGraph();\n            });\n\n            modal.getRoot().on(ModalEvents.hidden, () => {\n                // Destroy when hidden, removes modal HTML from document.\n                modal.destroy();\n            });\n\n            modal.show();\n\n            return modal;\n        }).fail(Notification.exception);\n    });\n};\n\n/**\n * Update the graph display based on values fetched from a webservice.\n *\n * @param {Number|null} startDatetime\n * @param {Number|null} endDateTime\n */\nconst updateGraph = (startDatetime = START_TIME, endDateTime = END_TIME) => {\n    if (START_TIME !== startDatetime) {\n        START_TIME = startDatetime;\n    }\n    if (END_TIME !== endDateTime) {\n        END_TIME = endDateTime;\n    }\n\n    let url = new URL(window.location.href);\n    let params = new URLSearchParams(url.search);\n    let courseid = null;\n    if (params.has('course')) {\n        courseid = parseInt(params.get('course'));\n    }\n    let engagementDataPromise = getUserEngagementData(courseid, USER_ID, START_TIME, END_TIME)\n        .then(function(response) {\n            if (response.error !== null) {\n                displayError(response.error);\n                return null;\n            } else if (response.series.length === 0) {\n                getString('noanalytics', 'local_ace').then((langString) => {\n                    displayError(langString);\n                    return;\n                }).catch();\n                return null;\n            }\n\n            // Populate empty fields.\n            let graphData = getGraphDataPlaceholder();\n            graphData.series[0].values = response.series;\n            // Create series for comparison data.\n            response.comparison.forEach((comparison) => {\n                let series = getSeriesPlaceholder();\n                series.label = comparison.label;\n                series.colors = [comparison.colour];\n                series.values = comparison.values;\n                series.fill = comparison.fill ? 1 : null;\n                graphData.series.push(series);\n            });\n            graphData.labels = response.labels;\n            graphData.axes.y[0].max = response.max;\n            graphData.axes.y[0].stepSize = response.stepsize;\n            let yLabels = {};\n            response.ylabels.forEach((element) => {\n                yLabels[element.value] = element.label;\n            });\n            graphData.axes.y[0].labels = yLabels;\n\n            return graphData;\n        }).catch(function() {\n            displayError(\"API returned an error\");\n        });\n\n    engagementDataPromise.then((data) => {\n        if (data === null) {\n            return;\n        }\n        let chartArea = document.querySelector('#chart-area-engagement');\n        let chartImage = chartArea.querySelector('.chart-image');\n        chartImage.innerHTML = \"\";\n        ChartBuilder.make(data).then((chart) => {\n            new ChartJSOutput(chartImage, chart);\n            return;\n        }).catch();\n        return;\n    }).catch();\n};\n\n/**\n * Display an error on the page, which replaces the engagement graphs on the page.\n *\n * @param {String} langString Text displayed on the page\n */\nconst displayError = (langString) => {\n    let chartArea = document.querySelector('#chart-area-engagement');\n    let chartImage = chartArea.querySelector('.chart-image');\n    chartImage.innerHTML = langString;\n};\n\n/**\n * Get analytics data for specific user and course, within a certain period and after a starting time.\n *\n * @param {Number|null} courseid Course ID\n * @param {Number} userid User ID\n * @param {Number} start Start time of analytics period in seconds\n * @param {Number} end End of analytics period in seconds\n * @param {String} comparison Comparison method\n * @returns {Promise}\n */\nconst getUserEngagementData = (courseid, userid, start, end, comparison = COMPARISON_OPTION) => {\n    return Ajax.call([{\n        methodname: 'local_ace_get_user_analytics_graph',\n        args: {\n            'courseid': courseid,\n            'userid': userid,\n            'start': start,\n            'end': end,\n            'comparison': comparison\n        },\n    }])[0];\n};\n\n/**\n * Get a graph.js data object filled out with the values we need for a student engagement graph.\n *\n * @returns {Object}\n */\nconst getGraphDataPlaceholder = () => {\n    return {\n        \"type\": \"line\",\n        \"series\": [\n            {\n                \"label\": \"Your engagement\",\n                \"labels\": null,\n                \"type\": null,\n                \"values\": null,\n                \"colors\": [COLOUR_USER_HISTORY],\n                \"fill\": null,\n                \"axes\": {\n                    \"x\": null,\n                    \"y\": null\n                },\n                \"urls\": [],\n                \"smooth\": null\n            }\n        ],\n        \"labels\": null,\n        \"title\": null,\n        \"axes\": {\n            \"x\": [],\n            \"y\": [\n                {\n                    \"label\": null,\n                    \"labels\": {},\n                    \"max\": null,\n                    \"min\": 0,\n                    \"position\": null,\n                    \"stepSize\": null\n                }\n            ]\n        },\n        \"legend_options\": {\n            \"display\": false\n        },\n        \"config_colorset\": null,\n        \"smooth\": true\n    };\n};\n\nconst getSeriesPlaceholder = () => {\n    return {\n        \"label\": \"\",\n        \"labels\": null,\n        \"type\": null,\n        \"values\": [],\n        \"colors\": [],\n        \"fill\": null,\n        \"axes\": {\n            \"x\": null,\n            \"y\": null\n        },\n        \"urls\": [],\n        \"smooth\": null\n    };\n};\n"],"file":"student_engagement.min.js"}