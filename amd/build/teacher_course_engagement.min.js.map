{"version":3,"sources":["../src/teacher_course_engagement.js"],"names":["COURSE_COLOUR_MATCH","HIDDEN_COURSES","init","updateGraph","startDate","endDate","engagementData","getTeacherCourseEngagementData","then","response","error","series","length","displayError","data","getGraphDataPlaceholder","forEach","label","parseInt","Math","random","toString","seriesData","getSeriesPlaceholder","values","colors","push","labels","xlabels","axes","y","max","stepSize","yLabels","ylabels","element","value","catch","chartArea","document","querySelector","chartImage","innerHTML","ChartBuilder","make","chart","ChartJSOutput","getHiddenCourses","courseList","preferences","split","ChartJS","helpers","each","instances","instance","dataset","datasets","datasetObject","includes","hidden","update","fail","Notification","exception","legendClickHandler","e","legendItem","index","datasetIndex","ci","meta","getDatasetMeta","filter","course","updateHiddenCourses","request","methodname","args","type","join","Ajax","call","name","langString","start","end"],"mappings":"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","sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Shows the teacher course engagement graph\n *\n * @module      local_ace/teacher_course_engagement\n * @copyright   2021 University of Canterbury\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport ChartBuilder from 'core/chart_builder';\nimport ChartJSOutput from 'core/chart_output_chartjs';\nimport {init as filtersInit} from 'local_ace/chart_filters';\nimport Notification from 'core/notification';\nimport ChartJS from 'core/chartjs-lazy';\n\n// Stores randomised colours against course shortnames.\nlet COURSE_COLOUR_MATCH = [];\n// List of course shortnames hidden on the graph.\nlet HIDDEN_COURSES = [];\n\nexport const init = () => {\n    filtersInit(updateGraph);\n    updateGraph(null, null);\n};\n\nconst updateGraph = (startDate, endDate) => {\n    let engagementData = getTeacherCourseEngagementData(startDate, endDate).then((response) => {\n        if (response.error !== null || response.series.length === 0) {\n            displayError(response.error);\n            return null;\n        }\n        let data = getGraphDataPlaceholder();\n        response.series.forEach((series) => {\n            // Store colours against courses so when switching history they stay the same colour.\n            if (!COURSE_COLOUR_MATCH[series.label]) {\n                COURSE_COLOUR_MATCH[series.label] = parseInt(Math.random() * 0xffffff).toString(16);\n            }\n            let seriesData = getSeriesPlaceholder();\n            seriesData.label = series.label;\n            seriesData.values = series.values;\n            seriesData.colors = ['#' + COURSE_COLOUR_MATCH[series.label]];\n            data.series.push(seriesData);\n        });\n        data.labels = response.xlabels;\n        data.axes.y[0].max = 100;\n        data.axes.y[0].stepSize = 20;\n        let yLabels = {};\n        response.ylabels.forEach((element) => {\n            yLabels[element.value] = element.label;\n        });\n        data.axes.y[0].labels = yLabels;\n        return data;\n    }).catch(() => {\n        displayError(\"API Error\");\n    });\n\n    engagementData.then((data) => {\n        if (data === null) {\n            return;\n        }\n        let chartArea = document.querySelector('#chart-area-engagement');\n        let chartImage = chartArea.querySelector('.chart-image');\n        chartImage.innerHTML = \"\";\n        ChartBuilder.make(data).then((chart) => {\n            new ChartJSOutput(chartImage, chart);\n\n            // Hides courses based on user preferences.\n            getHiddenCourses().then(response => {\n                if (response.error) {\n                    return;\n                }\n                let courseList = response.preferences[0].value;\n                if (courseList === null) {\n                    return;\n                }\n                HIDDEN_COURSES = courseList.split(\",\");\n                ChartJS.helpers.each(ChartJS.instances, function(instance) {\n                    let chart = instance.chart;\n                    for (let dataset in chart.data.datasets) {\n                        let datasetObject = chart.data.datasets[dataset];\n                        if (HIDDEN_COURSES.includes(datasetObject.label)) {\n                            datasetObject.hidden = true;\n                        }\n                    }\n                    chart.update();\n                });\n                return;\n            }).fail(Notification.exception);\n            return;\n        }).catch();\n        return;\n    }).catch();\n};\n\nconst getSeriesPlaceholder = () => {\n    return {\n        \"label\": \"\",\n        \"labels\": null,\n        \"type\": null,\n        \"values\": [],\n        \"colors\": [],\n        \"fill\": null,\n        \"axes\": {\n            \"x\": null,\n            \"y\": null\n        },\n        \"urls\": [],\n        \"smooth\": null\n    };\n};\n\nconst getGraphDataPlaceholder = () => {\n    return {\n        \"type\": \"line\",\n        \"series\": [],\n        \"labels\": [],\n        \"title\": \"Course Engagement\",\n        \"axes\": {\n            \"x\": [],\n            \"y\": [\n                {\n                    \"label\": null,\n                    \"labels\": {},\n                    \"max\": 100,\n                    \"min\": 0,\n                    \"position\": null,\n                    \"stepSize\": null\n                }\n            ]\n        },\n        \"legend_options\": {\n            \"display\": true,\n            \"position\": 'right',\n            \"onClick\": legendClickHandler\n        },\n        \"config_colorset\": null,\n        \"smooth\": true\n    };\n};\n\n/**\n * Handles clicks on dataset legends.\n *\n * @param {Object} e Event\n * @param {Object} legendItem Chart.JS Legend item\n */\nconst legendClickHandler = function(e, legendItem) {\n    let index = legendItem.datasetIndex;\n    let ci = this.chart;\n    let meta = ci.getDatasetMeta(index);\n\n    if (meta.hidden === null) {\n        if (ci.data.datasets[index].hidden) {\n            HIDDEN_COURSES = HIDDEN_COURSES.filter(course => course !== ci.data.datasets[index].label);\n            updateHiddenCourses();\n            ci.data.datasets[index].hidden = false;\n        } else {\n            HIDDEN_COURSES.push(ci.data.datasets[index].label);\n            updateHiddenCourses();\n            ci.data.datasets[index].hidden = true;\n        }\n    }\n\n    ci.update();\n};\n\n/**\n * Updates the hidden courses user preference, based on the HIDDEN_COURSES array.\n */\nconst updateHiddenCourses = function() {\n    let request = {\n        methodname: 'core_user_update_user_preferences',\n        args: {\n            preferences: [\n                {\n                    type: 'local_ace_teacher_hidden_courses',\n                    value: HIDDEN_COURSES.join(\",\")\n                }\n            ]\n        }\n    };\n\n    Ajax.call([request])[0]\n        .fail(Notification.exception);\n};\n\n/**\n * Gets the hidden courses from the user preferences.\n *\n * @returns {Promise}\n */\nconst getHiddenCourses = function() {\n    let request = {\n        methodname: 'core_user_get_user_preferences',\n        args: {\n            name: 'local_ace_teacher_hidden_courses'\n        }\n    };\n    return Ajax.call([request])[0];\n};\n\n/**\n * Display an error on the page, which replaces the engagement graphs on the page.\n *\n * @param {string} langString Text displayed on the page\n */\nconst displayError = (langString) => {\n    let chartArea = document.querySelector('#chart-area-engagement');\n    let chartImage = chartArea.querySelector('.chart-image');\n    chartImage.innerHTML = langString;\n};\n\n/**\n * Get teacher course analytics data\n *\n * @param {Number|null} start Start time of analytics period in seconds\n * @param {Number|null} end End of analytics period in seconds\n * @returns {Promise}\n */\nconst getTeacherCourseEngagementData = (start, end) => {\n    return Ajax.call([{\n        methodname: 'local_ace_get_teacher_course_analytics_graph',\n        args: {\n            'start': start,\n            'end': end\n        },\n    }])[0];\n};\n"],"file":"teacher_course_engagement.min.js"}